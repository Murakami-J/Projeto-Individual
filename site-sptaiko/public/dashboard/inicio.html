<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sptaiko</title>
    <link rel="stylesheet" href="../css/inicio.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="../js/sessao.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body onload="validarSessao(), atualizarFeed(), verificarCurtida()">

    <nav>
        <div class="div-logo">
            <img src="../assets/images/logoAnimada.gif" alt="Logo SPTaiko" class="img-logo">
        </div>

        <div class="nav-container">
            <ul>
                <li><a href="">INÍCIO</a></li>
                <span class="divisor"></span>
                <li onclick="exibirGrupos()" class="li-seta">GRUPOS <img src="../assets/images/seta-para-baixo.png"
                        alt="" class="seta-baixo"></li>
                <span class="divisor"></span>
                <ul class="ul-grupos" id="ul_grupos">
                    <li><a href="grupo.html" id="gp_acal">Acal Taiko</a></li>
                    <li><a href="grupo.html" id="gp_futurong">Futurong Taiko</a></li>
                    <li><a href="grupo.html" id="gp_himawari">Himawari Taiko</a></li>
                    <li><a href="grupo.html" id="gp_ikkon">Ikkon Wadaiko</a></li>
                    <li><a href="grupo.html" id="gp_mika">Mika Taiko</a></li>
                    <li><a href="grupo.html" id="gp_mugen">Mugen Daiko</a></li>
                    <li><a href="grupo.html" id="gp_sakura">Sakura Fubuki Taiko</a></li>
                    <li><a href="grupo.html" id="gp_soragoi">Soragoi Wadaiko</a></li>
                    <li><a href="grupo.html" id="gp_tenryuu">Tenryuu Wadaiko</a></li>
                    <li><a href="grupo.html" id="gp_todoroki">Todoroki Daiko</a></li>
                </ul>
                <li><a href="">EM ALTA</a></li>
                <span class="divisor"></span>
            </ul>
        </div>


        <div class="container-sair">
            <a href="../index.html">
                <img src="../assets/images/sair.png" alt="Sair">
                <p>SAIR</p>
            </a>
        </div>
    </nav>

    <div class="header-container">
        <div class="div-header">
            <span id="b_usuario">Usuário</span>

            <div class="div-perfil-usuario">
            </div>
        </div>
    </div>
    <div class="publicacao-pai">
        <div class="publicacao-container" id="div_publicacao_container">
            <button class="bt-nova-publicacao" onclick="adicionarNovaPublicacao()">
                <span class="material-symbols-outlined">
                    add_circle
                </span>
                <p>Nova Publicação</p>
            </button>

            <span id="overlay">
                <div class="publicacoes" id="div_publicacoes">
                    <img src="../assets/images/seta-branca.png" onclick="fecharNovaPublicacao()">
                    <div class="container">
                        <p>Criar uma nova publicação</p>
                        <div class="div-form">
                            <form id="form_postagem" method="post" onsubmit="return publicar()">
                                <label>
                                    Título
                                    <br>
                                    <input name="titulo" id="titulo" maxlength="100" type="text">
                                </label>
                                <br>
                                <br>
                                <label>
                                    Descrição
                                    <br>
                                    <textarea name="descricao" id="textarea_descricao" maxlength="250"
                                        rows="5"></textarea>
                                </label>
                                <br>
                                <br>
                                <button>Publicar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </span>


            <!-- <h1>Mural de Avisos</h1> -->
            <div class="div-results">
                <div id="feed_container" class="feed-container">
                </div>
            </div>

        </div>
    </div>


    <script src="https://unpkg.com/ionicons@5.4.0/dist/ionicons.js"></script>
</body>

</html>

<script>


    b_usuario.innerHTML = sessionStorage.NOME_USUARIO + sessionStorage.ID_USUARIO;
    let contador = 0;
    function exibirGrupos() {

        if (contador % 2 == 0) {

            gp_acal.style.display = 'flex';
            gp_futurong.style.display = 'flex';
            gp_himawari.style.display = 'flex';
            gp_ikkon.style.display = 'flex';
            gp_mika.style.display = 'flex';
            gp_mugen.style.display = 'flex';
            gp_sakura.style.display = 'flex';
            gp_soragoi.style.display = 'flex';
            gp_tenryuu.style.display = 'flex';
            gp_todoroki.style.display = 'flex';


        } else {
            gp_acal.style.display = 'none';
            gp_futurong.style.display = 'none';
            gp_himawari.style.display = 'none';
            gp_ikkon.style.display = 'none';
            gp_mika.style.display = 'none';
            gp_mugen.style.display = 'none';
            gp_sakura.style.display = 'none';
            gp_soragoi.style.display = 'none';
            gp_tenryuu.style.display = 'none';
            gp_todoroki.style.display = 'none';

        }
        contador += 1;
    }

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    function limparFormulario() {
        document.getElementById("form_postagem").reset();
    }

    function adicionarNovaPublicacao() {
        div_publicacoes.style.display = 'flex';
        document.getElementById("overlay").style.display = "flex";
    }

    function fecharNovaPublicacao() {
        div_publicacoes.style.display = 'none';
        document.getElementById("overlay").style.display = "none";
    }

    function publicar() {
        var idUsuario = sessionStorage.ID_USUARIO;

        var corpo = {
            titulo: form_postagem.titulo.value,
            descricao: form_postagem.descricao.value
        }

        fetch(`/publicacoes/publicar/${idUsuario}`, {
            method: "post",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(corpo)
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                window.alert("Post realizado com sucesso pelo usuario de ID: " + idUsuario + "!");
                window.location = "/dashboard/inicio.html";
                limparFormulario();
                finalizarAguardar();
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            finalizarAguardar();
        });

        return false;

    }

    function editar(idAviso) {
        sessionStorage.ID_POSTAGEM_EDITANDO = idAviso;
        console.log("cliquei em editar - " + idAviso);
        window.alert("Você será redirecionado à página de edição do aviso de id número: " + idAviso);
        window.location = "/dashboard/edicao-aviso.html"

    }

    function deletar(idAviso) {
        console.log("Criar função de apagar post escolhido - ID" + idAviso);
        fetch(`/publicacoes/deletar/${idAviso}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {

            if (resposta.ok) {
                window.alert("Post deletado com sucesso pelo usuario de email: " + sessionStorage.getItem("EMAIL_USUARIO") + "!");
                window.location = "/dashboard/inicio.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    let qtdCurtida = 0;
    function atualizarFeed() {
        fetch("/publicacoes/listar").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    var feed = document.getElementById("feed_container");
                    var mensagem = document.createElement("span");
                    mensagem.innerHTML = "Nenhum resultado encontrado."
                    feed.appendChild(mensagem);
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    var feed = document.getElementById("feed_container");
                    feed.innerHTML = "";
                    for (let i = 0; i < resposta.length; i++) {
                        var publicacao = resposta[i];

                        // criando e manipulando elementos do HTML via JavaScript
                        var divPublicacao = document.createElement("div");
                        var spanID = document.createElement("span");
                        var spanTitulo = document.createElement("span");
                        var spanNome = document.createElement("span");
                        var divDescricao = document.createElement("div");
                        var divButtons = document.createElement("div");
                        // var btnEditar = document.createElement("button");
                        // var btnDeletar = document.createElement("button");


                        spanNome.innerHTML = `<ion-icon name="person-circle" class="usuario"></ion-icon> <div><p class="p-nome-usuario">${publicacao.nome} </p><p class="p-data-publicacao">${publicacao.dataPublicacao}</p></div>`;
                        divDescricao.innerHTML = `<p class="p-titulo-publicacao">${publicacao.titulo}</p> 
                        <p>${publicacao.descricao}</p>
                        <div class="div-interacoes" id="div_interacoes">
                            <div class="container-curtidas">
                                <ion-icon name="heart-outline" class="curtida" id="icon_curtida${publicacao.idAviso}"></ion-icon><input type="checkbox" class="chk-curtida" id="${publicacao.idAviso}" onclick="listarFkAutor()">
                                <p id="p_qtdCurtida${publicacao.idAviso}">0</p>
                            </div>
                            <ion-icon name="chatbubble-ellipses-outline" class="comentarios"></ion-icon>
                        </div>
                        `;

                        // <fieldset class="check-image">
                        //     <label for="like">
                        //         <input type="checkbox" name="like" id="like">
                        //         <i></i>
                        //      </label>
                        // </fieldset>

                        // btnEditar.innerHTML = "Editar";
                        // btnDeletar.innerHTML = "Deletar";

                        divPublicacao.className = "publicacao-feed";
                        spanTitulo.id = "inputNumero" + publicacao.idAviso;
                        spanNome.className = "publicacao-nome";
                        spanTitulo.className = "publicacao-titulo";
                        divDescricao.className = "publicacao-descricao";

                        divButtons.className = "div-buttons"

                        // btnEditar.className = "publicacao-btn-editar"
                        // btnEditar.id = "btnEditar" + publicacao.idAviso;
                        // btnEditar.setAttribute("onclick", `editar(${publicacao.idAviso})`);

                        // btnDeletar.className = "publicacao-btn-editar"
                        // btnDeletar.id = "btnDeletar" + publicacao.idAviso;
                        // btnDeletar.setAttribute("onclick", `deletar(${publicacao.idAviso})`);

                        divPublicacao.appendChild(spanID);
                        divPublicacao.appendChild(spanNome);
                        divPublicacao.appendChild(spanTitulo);
                        divPublicacao.appendChild(divDescricao);
                        divPublicacao.appendChild(divButtons);
                        // divButtons.appendChild(btnEditar);
                        // divButtons.appendChild(btnDeletar);
                        feed.appendChild(divPublicacao);


                        var idUsuario = sessionStorage.ID_USUARIO;
                        var idPublicacao = publicacao.idAviso;
                        var fkAutor = publicacao.fkAutor;

                        fetch(`/interacoes/listarCurtidas/${idUsuario}/${idPublicacao}/${fkAutor}`).then(function (resposta) {
                            if (resposta.ok) {
                                if (resposta.status == 204) {
                                    throw "Nenhum resultado encontrado!!";
                                }
                                resposta.json().then(function (resposta) {
                                    for (let i = 0; i < resposta.length; i++) {
                                        var publicacao = resposta[i];

                                        if (publicacao.curtida) {
                                            var p_curtida = document.getElementById(`p_qtdCurtida${publicacao.fkPublicacao}`);
                                            p_curtida.innerHTML = publicacao.curtida;

                                        }


                                    }

                                });
                            } else {
                                throw ('Houve um erro na API!');
                            }
                        }).catch(function (resposta) {
                            console.error(resposta);

                        });

                    }
                    fetch(`/interacoes/listarCurtidasPorUsuario/${idUsuario}/${idPublicacao}/${fkAutor}`).then(function (resposta) {
                        if (resposta.ok) {
                            if (resposta.status == 204) {
                                throw "Nenhum resultado encontrado!!";
                            }
                            resposta.json().then(function (resposta) {
                                for (let i = 0; i < resposta.length; i++) {
                                    var publicacao = resposta[i];

                                    console.log(publicacao.fkUsuario)
                                    const icon = document.getElementById(`icon_curtida${publicacao.fkPublicacao}`);

                                    if (idUsuario == publicacao.fkUsuario) {
                                        console.log("Já curtiu esse comentario")
                                        icon.name = "heart";
                                        icon.style.color = "red";

                                    } else {
                                        console.log("Não curtiu")
                                        icon.name = "heart-outline";
                                        icon.style.color = "black";
                                    }

                                }

                            });
                        } else {
                            throw ('Houve um erro na API!');
                        }
                    }).catch(function (resposta) {
                        console.error(resposta);

                    });


                    finalizarAguardar();
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
            finalizarAguardar();
        });

    }

    let fkAutor = '';
    function listarFkAutor() {
        fetch("/publicacoes/listar").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    // for (let i = 0; i < resposta.length; i++) {
                    var publicacao = resposta[0];
                    fkAutor = publicacao.fkAutor;

                    console.log("OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO" + fkAutor)
                    // }

                    verificarCheck();
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);

        });

    }


    function verificarCheck() {
        var idUsuario = sessionStorage.ID_USUARIO;

        // Selecione todos os elementos de checkbox
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        // Remova todos os ouvintes de eventos de clique para evitar a duplicação
        checkboxes.forEach(function (checkbox) {
            checkbox.removeEventListener('click', handleCheckboxClick);
        });
        // Adicione um evento de clique a cada checkbox
        checkboxes.forEach(function (checkbox) {
            checkbox.addEventListener('click', handleCheckboxClick);
        });
    }


    let contadorCurtidas;
    function handleCheckboxClick() {
        var idUsuario = sessionStorage.ID_USUARIO;

        // Selecione todos os elementos de checkbox
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        // Adicione um evento de clique a cada checkbox

        // checkboxes.forEach(function (checkbox) {
        //     checkbox.addEventListener('click', function () {

        if (this.checked) {
            const icon = document.getElementById(`icon_curtida${this.id}`);
            icon.name = "heart";
            icon.style.color = "red";
            console.log('O checkbox com o ID ' + this.id + ' está selecionado.' + fkAutor);

            var idPublicacao1 = this.id
            fetch(`/interacoes/cadastrarCurtida/${idUsuario}/${idPublicacao1}/${fkAutor}`, {
                method: "POST"

            }).then(function (resposta) {

                console.log("resposta: ", resposta);

                if (resposta.ok) {

                    var p_curtida = document.getElementById(`p_qtdCurtida${idPublicacao1}`);
                    qtdCurtida = document.getElementById(`p_qtdCurtida${idPublicacao1}`).innerText;
                    contadorCurtidas = parseInt(qtdCurtida)
                    contadorCurtidas += 1;
                    p_curtida.innerHTML = contadorCurtidas;
                    // window.alert("Curtida realizado com sucesso pelo usuario de ID: " + idUsuario + "!");
                    // window.location = "/dashboard/inicio.html";

                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

            // return false;

        } else {
            const icon = document.getElementById(`icon_curtida${this.id}`);
            icon.name = "heart-outline";
            icon.style.color = "black";
            console.log('O checkbox com o ID ' + this.id + ' não está selecionado.');

            var idPublicacao = this.id

            fetch(`/interacoes/listar/${idUsuario}/${idPublicacao}/${fkAutor}`, {
            }).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }

                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));

                        /* =================================================================================================*/

                        fetch(`/interacoes/deletarCurtida/${idUsuario}/${idPublicacao}/${fkAutor}`, {
                            method: "DELETE",

                        }).then(function (resposta) {

                            console.log("resposta: ", resposta);

                            if (resposta.ok) {
                                var p_curtida = document.getElementById(`p_qtdCurtida${idPublicacao}`);
                                qtdCurtida = document.getElementById(`p_qtdCurtida${idPublicacao}`).innerText;
                                contadorCurtidas = parseInt(qtdCurtida)
                                contadorCurtidas -= 1;
                                console.log("AQUI: " + contadorCurtidas)
                                p_curtida.innerHTML = contadorCurtidas;
                                // var p_curtida = document.getElementById(`p_qtdCurtida${idPublicacao}`);
                                // qtdCurtida -= 1;
                                // p_curtida.innerHTML = qtdCurtida;
                                // window.alert("Curtida deletada com sucesso pelo usuario de ID: " + idUsuario + "!");
                                // window.location = "/dashboard/inicio.html";

                            } else if (resposta.status == 404) {
                                window.alert("Deu 404!");
                            } else {
                                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                            }
                        }).catch(function (resposta) {
                            console.log(`#ERRO: ${resposta}`);
                        });

                        // return false;


                        /* =================================================================================================*/

                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });

        }
        //     });
        // });
    }


    // fetch(`/interacoes/deletarCurtida/${idUsuario}`, {
    //                     method: "DELETE",
    //                     headers: {
    //                         "Content-Type": "application/json"
    //                     },
    //                     body: JSON.stringify(corpo)
    //                 }).then(function (resposta) {

    //                     console.log("resposta: ", resposta);

    //                     if (resposta.ok) {
    //                         window.alert("Curtida deletada com sucesso pelo usuario de ID: " + idUsuario + "!");
    //                         // window.location = "/dashboard/inicio.html";

    //                     } else if (resposta.status == 404) {
    //                         window.alert("Deu 404!");
    //                     } else {
    //                         throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
    //                     }
    //                 }).catch(function (resposta) {
    //                     console.log(`#ERRO: ${resposta}`);
    //                 });

    //                 return false;


    function verificarCurtida() {


    }







    // var a = 0;
    // function listarCurtidas() {
    //     var idUsuario = sessionStorage.ID_USUARIO;

    //     var corpo = {
    //         idPublicacao: this.id,
    //         fk_Autor: fkAutor
    //     }

    //     fetch("/interacoes/listar").then(function (resposta) {
    //         if (resposta.ok) {
    //             if (resposta.status == 204) {
    //                 throw "Nenhum resultado encontrado!!";
    //             }

    //             resposta.json().then(function (resposta) {
    //                 console.log("Dados recebidos: ", JSON.stringify(resposta));

    //                 if (resposta.length > 0) {
    //                     for (let i = 0; i < resposta.length; i++) {
    //                         var curtida = resposta[i];
    //                     }
    //                 } else {
    //                 }

    //             });
    //         } else {
    //             throw ('Houve um erro na API!');
    //         }
    //     }).catch(function (resposta) {
    //         console.error(resposta);
    //     });
    // }



    // function cadastrarCurtida() {
    //     var idUsuario = sessionStorage.ID_USUARIO;

    //     var corpo = {
    //         titulo: form_postagem.titulo.value,
    //         descricao: form_postagem.descricao.value
    //     }

    //     fetch(`/avisos/publicar/${idUsuario}`, {
    //         method: "post",
    //         headers: {
    //             "Content-Type": "application/json"
    //         },
    //         body: JSON.stringify(corpo)
    //     }).then(function (resposta) {

    //         console.log("resposta: ", resposta);

    //         if (resposta.ok) {
    //             window.alert("Post realizado com sucesso pelo usuario de ID: " + idUsuario + "!");
    //             window.location = "/dashboard/mural.html";
    //             limparFormulario();
    //             finalizarAguardar();
    //         } else if (resposta.status == 404) {
    //             window.alert("Deu 404!");
    //         } else {
    //             throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
    //         }
    //     }).catch(function (resposta) {
    //         console.log(`#ERRO: ${resposta}`);
    //         finalizarAguardar();
    //     });

    //     return false;

    // }


    function deletar() {
        var idUsuario = sessionStorage.ID_USUARIO;

        var corpo = {
            idPublicacao: idAviso,
            fk_Autor: fkAutor
        }

        console.log("Criar função de apagar post escolhido - ID " + idUsuario, idAviso, fkAutor);
        fetch(`/interacoes/deletarCurtida/${idAviso}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {

            if (resposta.ok) {
                window.alert("Comentario deletado com sucesso pelo usuario de email: " + sessionStorage.getItem("EMAIL_USUARIO") + "!");
                window.location = "/dashboard/inicio.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }
</script>