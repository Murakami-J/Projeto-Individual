<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Início | Sptaiko</title>
    <link rel="stylesheet" href="../css/inicio.css">
    <link rel="stylesheet" href="../css/comentarios.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="../js/sessao.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body
    onload="validarSessao(), atualizarFeed(), comentario.selecionarPublicacao(), comentario.listar(), comentario.verificarVisibilidade()">

    <!-- MENU LATERAL -->
    <nav>
        <div class="div-logo">
            <img src="../assets/images/logoAnimada.gif" alt="Logo SPTaiko" class="img-logo">
        </div>

        <div class="nav-container">
            <ul>
                <li><a href="">INÍCIO</a></li>
                <span class="divisor"></span>
                <li onclick="exibirMenuGrupos()" class="li-seta">GRUPOS <img src="../assets/images/seta-para-baixo.png"
                        alt="" class="seta-baixo"></li>
                <span class="divisor"></span>
                <ul class="ul-grupos" id="ul_grupos">
                    <li><a href="grupo.html" id="gp_acal">Acal Taiko</a></li>
                    <li><a href="grupo.html" id="gp_futurong">Futurong Taiko</a></li>
                    <li><a href="grupo.html" id="gp_himawari">Himawari Taiko</a></li>
                    <li><a href="grupo.html" id="gp_ikkon">Ikkon Wadaiko</a></li>
                    <li><a href="grupo.html" id="gp_mika">Mika Taiko</a></li>
                    <li><a href="grupo.html" id="gp_mugen">Mugen Daiko</a></li>
                    <li><a href="grupo.html" id="gp_sakura">Sakura Fubuki Taiko</a></li>
                    <li><a href="grupo.html" id="gp_soragoi">Soragoi Wadaiko</a></li>
                    <li><a href="grupo.html" id="gp_tenryuu">Tenryuu Wadaiko</a></li>
                    <li><a href="grupo.html" id="gp_todoroki">Todoroki Daiko</a></li>
                </ul>
                <li><a href="emAlta.html">EM ALTA</a></li>
                <span class="divisor"></span>
            </ul>
        </div>

        <div class="container-sair">
            <a href="../index.html">
                <img src="../assets/images/sair.png" alt="Sair">
                <p>SAIR</p>
            </a>
        </div>
    </nav>

    <!-- HEADER -->
    <div class="header-container">
        <div class="div-header">
            <div class="header-titulo">
                <p>Publicações</p>
            </div>
            <div class="header-pesquisar">
                <input type="text" placeholder="Pesquisar" id="input_pesquisar" onkeyup="atualizarFeed()">
                <ion-icon name="search-outline" class="icon-pesquisar"></ion-icon>
            </div>
            <div class="div-perfil-usuario">
                <ion-icon name="person-circle" class="header-icon-perfil"></ion-icon>
            </div>
        </div>
    </div>
    <div class="publicacao-pai">
        <div class="publicacao-container" id="div_publicacao_container">
            <button class="bt-nova-publicacao" onclick="publicacao.exibirModalAdicionarNovaPublicacao()">
                <span class="material-symbols-outlined">
                    add_circle
                </span>
                <p>Nova Publicação</p>
            </button>

            <!-- DIV NOVA PUBLICAÇÃO -->
            <span id="overlay">
                <div class="publicacoes" id="div_publicacoes">
                    <img src="../assets/images/seta-branca.png"
                        onclick="publicacao.fecharModalAdicionarNovaPublicacao()">
                    <div class="container">
                        <p>Criar uma nova publicação</p>
                        <div class="div-form">
                            <form id="form_postagem" method="post" onsubmit="return publicacao.publicar()">
                                <label>
                                    Título
                                    <br>
                                    <input name="titulo" id="titulo" maxlength="45" type="text">
                                </label>
                                <br>
                                <br>
                                <label>
                                    Descrição
                                    <br>
                                    <textarea name="descricao" id="textarea_descricao" maxlength="1000"
                                        rows="5"></textarea>
                                </label>
                                <br>
                                <br>
                                <button id="bt_publicar">Publicar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </span>

            <!-- DIV COMENTÁRIOS -->
            <span id="overlay1">
                <div class="div-pai-comentarios" id="div_pai_comentarios">
                    <div class="div-container-comentarios">
                        <div class="div-comentarios-publicacao">
                            <div class="div-publicar-comentarios">
                                <input type="text" name="input_comentarios" class="input-comentarios"
                                    id="input_comentarios" placeholder="Escreva um comentário" maxlength="500">
                                <button class="bt-enviar-comentarios" onclick="comentario.publicar()"
                                    id="bt_enviar_comentarios">
                                    Enviar
                                </button>
                            </div>
                            <div id="div_publicacao" class="div-publicacao">
                                <ion-icon name="close-outline" class="icon-close"
                                    onclick="comentario.fecharModal()"></ion-icon>
                                <div id="div_informacoes-pai">
                                    <div id="div_container_pub">
                                    </div>
                                </div>
                                <div id="div_comentarios_pai">
                                    <div id="div_container_comentarios">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </span>

            <!-- DIV CONFIRMAÇÃO DE EXCLUSÃO DE PUBLICAÇÃO -->
            <span id="overlay2">
                <div class="div-pai-aviso-deletar">
                    <div class="div-container-aviso-deletar">
                        <div class="div-titulo-aviso">
                            <p>Tem certeza que deseja excluir</p>
                            <p id="p_aviso_titulo">"Publicacao" ?</p>
                        </div>
                        <div class="div-bt-aviso">
                            <button id="bt_cancelar_aviso" onclick="exclusaoPublicacao.exibirModalAviso()">
                                Cancelar
                            </button>
                            <button id="bt_exluir_aviso">
                                Sim, excluir
                            </button>
                        </div>
                    </div>
                </div>
            </span>

            <!-- DIV EDITAR PUBLICAÇÃO -->
            <span id="overlay3">
                <div class="publicacoes">
                    <img src="../assets/images/seta-branca.png" onclick="edicaoPublicacao.fecharModal()">
                    <div class="container">
                        <p>Editar sua publicação</p>
                        <div class="div-form">
                            <label>
                                Título
                                <br>
                                <input name="titulo_edicao" id="titulo_edicao" maxlength="45" type="text">
                            </label>
                            <br>
                            <br>
                            <label>
                                Descrição
                                <br>
                                <textarea name="descricao_edicao" id="textarea_edicao" maxlength="1000"
                                    rows="5"></textarea>
                            </label>
                            <br>
                            <br>
                            <button id="bt_edicao">Editar</button>
                        </div>
                    </div>
                </div>
            </span>

            <!-- DIV FEED -->
            <div class="div-results">
                <div id="feed_container" class="feed-container">
                </div>
            </div>

        </div>
    </div>


    <script src="https://unpkg.com/ionicons@5.4.0/dist/ionicons.js"></script>
</body>

</html>

<script>
    // EXIBIR MENU GRUPOS =======================================================================================
    let contador = 0;
    function exibirMenuGrupos() {
        if (contador % 2 == 0) {
            gp_acal.style.display = 'flex';
            gp_futurong.style.display = 'flex';
            gp_himawari.style.display = 'flex';
            gp_ikkon.style.display = 'flex';
            gp_mika.style.display = 'flex';
            gp_mugen.style.display = 'flex';
            gp_sakura.style.display = 'flex';
            gp_soragoi.style.display = 'flex';
            gp_tenryuu.style.display = 'flex';
            gp_todoroki.style.display = 'flex';


        } else {
            gp_acal.style.display = 'none';
            gp_futurong.style.display = 'none';
            gp_himawari.style.display = 'none';
            gp_ikkon.style.display = 'none';
            gp_mika.style.display = 'none';
            gp_mugen.style.display = 'none';
            gp_sakura.style.display = 'none';
            gp_soragoi.style.display = 'none';
            gp_tenryuu.style.display = 'none';
            gp_todoroki.style.display = 'none';
        }
        contador += 1;
    }

    // USUÁRIO =======================================================================================

    const usuario = {
        id: sessionStorage.ID_USUARIO,
        nome: sessionStorage.NOME_USUARIO,
        email: sessionStorage.EMAIL_USUARIO
    };

    const idUsuario = sessionStorage.ID_USUARIO;


    // PUBLICAÇÃO =======================================================================================

    function limparFormulario() {
        document.getElementById("form_postagem").reset();
    }

    const publicacao = {
        exibirModalAdicionarNovaPublicacao: function () {
            div_publicacoes.style.display = 'flex';
            document.getElementById("overlay").style.display = "flex";
        },
        fecharModalAdicionarNovaPublicacao: function () {
            div_publicacoes.style.display = 'none';
            document.getElementById("overlay").style.display = "none";
        },
        exibir: function (resposta) {
            const feed = document.getElementById("feed_container");
            feed.innerHTML = "";
            for (let i = 0; i < resposta.length; i++) {
                var publicacao = resposta[i];

                // criando e manipulando elementos do HTML via JavaScript
                var divPublicacao = document.createElement("div");
                var spanID = document.createElement("span");
                var spanTitulo = document.createElement("span");
                var spanNome = document.createElement("span");
                var divDescricao = document.createElement("div");
                var divButtons = document.createElement("div");
                var divContainer = document.createElement("div");
                divContainer.className = "div-container-info-pub";

                spanNome.innerHTML = `
                <ion-icon name="person-circle" class="usuario"></ion-icon> 
                <div>
                    <p class="p-nome-usuario">${publicacao.nome}</p>
                    <p class="p-data-publicacao">${publicacao.dataPublicacao}</p>
                </div>
                `;

                divDescricao.innerHTML = `<p class="p-titulo-publicacao">${publicacao.titulo}</p> 
                        <p class="p-descricao">${publicacao.descricao}</p>
                        <div class="div-interacoes" id="div_interacoes">
                            <div class="container-curtidas">
                                <ion-icon name="heart-outline" class="curtida" id="icon_curtida${publicacao.idAviso}"></ion-icon><input type="checkbox" class="chk-curtida" id="${publicacao.idAviso}" onclick="listarFkAutor()">
                                <p id="p_qtdCurtida${publicacao.idAviso}">0</p>
                            </div>
                            <div class="container-comentario">
                                <ion-icon name="chatbubble-ellipses-outline" class="comentarios" id="icon_id"></ion-icon>
                                <input type="radio" class="radio-comentarios" name="comentarios" value="${publicacao.idAviso}" onclick="comentario.exibirModal()">
                                <p id="p_qtdComentario${publicacao.idAviso}">0</p>
                            </div>    
                        </div>
                        `;

                divPublicacao.className = "publicacao-feed";
                spanTitulo.id = "inputNumero" + publicacao.idAviso;
                spanNome.className = "publicacao-nome";
                spanTitulo.className = "publicacao-titulo";
                divDescricao.className = "publicacao-descricao";
                divButtons.className = "div-buttons"

                divContainer.appendChild(spanNome);
                divPublicacao.appendChild(divContainer);
                divPublicacao.appendChild(spanID);
                // divPublicacao.appendChild(spanNome);
                divPublicacao.appendChild(spanTitulo);
                divPublicacao.appendChild(divDescricao);
                divPublicacao.appendChild(divButtons);

                feed.appendChild(divPublicacao);

                const publicacaoPesquisada = document.getElementById("input_pesquisar").value.toUpperCase();
                const posicaoDescricao = publicacao.descricao.toUpperCase().indexOf(publicacaoPesquisada);
                const posicaoTitulo = publicacao.titulo.toUpperCase().indexOf(publicacaoPesquisada);

                if(posicaoDescricao == -1 && posicaoTitulo == -1){
                    divPublicacao.style.display = 'none';
                }

                var idPublicacao = publicacao.idAviso;
                var fkAutor = publicacao.fkAutor;

                curtida.listar(idPublicacao, fkAutor);
                if (usuario.id == fkAutor) {
                    this.exibirOpcoesAutor(divContainer, idPublicacao, fkAutor);
                }
            }
            curtida.listarPorUsuario(idPublicacao, fkAutor);
            comentario.exibirTotal();

        },
        exibirOpcoesAutor: function (divContainer, idPublicacao, fkAutor) {
            divContainer.innerHTML += `
            <div>
                <ion-icon name="create-outline" id="${idPublicacao}" class="icon-opcao")" onclick="edicaoPublicacao.iniciar(${idPublicacao}, ${fkAutor})"></ion-icon>
                <ion-icon name="trash-outline" class="icon-opcao" onclick="exclusaoPublicacao.exibirModalDeletar(${idPublicacao}, ${fkAutor})"></ion-icon>
            </div>
            `;
        },
        publicar: function () {
            const titulo = form_postagem.titulo.value;
            const descricao = form_postagem.descricao.value;

            fetch(`/publicacoes/publicar/${usuario.id}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    titulo: titulo,
                    descricao: descricao
                })
            }).then(function (resposta) {
                if (resposta.ok) {
                    window.alert(`Publicação realizada com sucesso pelo usuario: ${usuario.nome}`);
                    window.location = "/dashboard/inicio.html";
                    limparFormulario();
                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw new Error("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (erro) {
                console.error(`#ERRO: ${erro}`);
            });
            
            return false;
        }
    }

    function atualizarFeed() {
        fetch("/publicacoes/listar").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    var feed = document.getElementById("feed_container");
                    var mensagem = document.createElement("span");
                    mensagem.innerHTML = "Nenhum resultado encontrado."
                    feed.appendChild(mensagem);
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    publicacao.exibir(resposta);
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });

    }


    // EXCLUSÃO PUBLICAÇÃO =======================================================================================
    const exclusaoPublicacao = {
        exibirModalDeletar: function (idPublicacao, fkAutor) {
            this.exibirTitulo(idPublicacao, fkAutor);
            let avisoExcluir = document.getElementById('overlay2');
            avisoExcluir.style.display = 'flex'

            document.getElementById('bt_exluir_aviso').onclick = function () {
                exclusaoPublicacao.deletar(idPublicacao, fkAutor);
            }
        },
        deletar: function (idPublicacao, fkAutor) {
            console.log("Criar função de apagar post escolhido - ID" + idPublicacao);
            fetch(`/publicacoes/deletarPublicacao/${idPublicacao}/${fkAutor}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(function (resposta) {

                if (resposta.ok) {
                    window.alert("Publicação deletada com sucesso pelo usuario: " + usuario.nome);
                    window.location = "/dashboard/inicio.html"
                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        },
        exibirTitulo: function (idPublicacao, fkAutor) {
            fetch(`/publicacoes/exibirTituloPublicacaoEdicao/${idPublicacao}/${fkAutor}`).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    resposta.json().then(function (resposta) {
                        let tituloPublicacaoEdicao = document.getElementById("p_aviso_titulo");

                        console.log("Dados recebidos: INFOPUB ", JSON.stringify(resposta));
                        for (let i = 0; i < resposta.length; i++) {
                            var publicacao = resposta[i];

                            tituloPublicacaoEdicao.innerHTML = `"${publicacao.titulo}"?`
                        }
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);

            });
        },
        exibirModalAviso: function () {
            let avisoExcluir = document.getElementById('overlay2')
            avisoExcluir.style.display = 'none'
        },

    }

    // EDITAR PUBLICAÇÃO =============================================================
    const edicaoPublicacao = {
        exibirModal: function () {
            const telaEdicao = document.getElementById("overlay3");
            telaEdicao.style.display = 'flex';
        },
        fecharModal: function () {
            let telaEdicao = document.getElementById("overlay3");
            telaEdicao.style.display = 'none';
        },
        exibirInformacoes: function (idPublicacao, fkAutor) {
            fetch(`/publicacoes/exibirInformacoesPublicacao/${idPublicacao}/${fkAutor}`).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    resposta.json().then(function (resposta) {
                        const tituloFormularioEdicao = document.getElementById("titulo_edicao");
                        const descricaoFormularioEdicao = document.getElementById("textarea_edicao");

                        console.log("Dados recebidos: INFOPUB ", JSON.stringify(resposta));
                        for (let i = 0; i < resposta.length; i++) {
                            var publicacao = resposta[i];

                            tituloFormularioEdicao.value = publicacao.titulo;
                            descricaoFormularioEdicao.value = publicacao.descricao;
                        }
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);

            });
        },
        editar: function (idPublicacao, fkAutor) {
            const tituloPublicacao = titulo_edicao.value;
            const descricaoPublicacao = textarea_edicao.value;

            fetch(`/publicacoes/editar/${idPublicacao}/${fkAutor}/${tituloPublicacao}/${descricaoPublicacao}`, {
                method: "PUT"
            }).then(function (resposta) {

                if (resposta.ok) {
                    window.alert(`Publicação editada com sucesso pelo usuario: ${usuario.nome}`);
                    window.location = "/dashboard/inicio.html";

                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        },
        iniciar: function (idPublicacao, fkAutor) {
            this.exibirModal();
            this.exibirInformacoes(idPublicacao, fkAutor)

            document.getElementById('bt_edicao').onclick = function () {
                edicaoPublicacao.editar(idPublicacao, fkAutor);
            }
        }
    }


    // CURTIDA =======================================================================
    let listafkAutor = [];
    function listarFkAutor() {
        fetch("/publicacoes/listar").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {

                    for (let i = 0; i < resposta.length; i++) {
                        var publicacao = resposta[i];

                        listafkAutor[i] = {
                            idPublicacao: publicacao.idAviso,
                            fkAutor: publicacao.fkAutor
                        };

                    }
                    verificarCheck();
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);

        });

    }

    const curtida = {
        cadastrar: function (idPublicacao, fkAutor) {
            fetch(`/interacoes/cadastrarCurtida/${usuario.id}/${idPublicacao}/${fkAutor}`, {
                method: "POST"
            }).then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    var p_curtida = document.getElementById(`p_qtdCurtida${idPublicacao}`);
                    qtdCurtida = document.getElementById(`p_qtdCurtida${idPublicacao}`).innerText;
                    contadorCurtidas = parseInt(qtdCurtida)
                    contadorCurtidas += 1;
                    p_curtida.innerHTML = contadorCurtidas;
                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        },
        deletar: function (idPublicacao, fkAutor) {
            fetch(`/interacoes/deletarCurtida/${usuario.id}/${idPublicacao}/${fkAutor}`, {
                method: "DELETE",
            }).then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    var p_curtida = document.getElementById(`p_qtdCurtida${idPublicacao}`);
                    qtdCurtida = document.getElementById(`p_qtdCurtida${idPublicacao}`).innerText;
                    contadorCurtidas = parseInt(qtdCurtida)
                    contadorCurtidas -= 1;
                    console.log("AQUI: " + contadorCurtidas)
                    p_curtida.innerHTML = contadorCurtidas;

                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        },
        listar: function (idPublicacao, fkAutor) {
            fetch(`/interacoes/listarCurtidas/${usuario.id}/${idPublicacao}/${fkAutor}`).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    resposta.json().then(function (resposta) {
                        for (let i = 0; i < resposta.length; i++) {
                            var publicacao = resposta[i];

                            if (publicacao.curtida) {
                                var p_curtida = document.getElementById(`p_qtdCurtida${publicacao.fkPublicacao}`);
                                p_curtida.innerHTML = publicacao.curtida;
                            }
                        }
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });
        },
        listarPorUsuario: function (idPublicacao, fkAutor) {
            fetch(`/interacoes/listarCurtidasPorUsuario/${usuario.id}/${idPublicacao}/${fkAutor}`).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    resposta.json().then(function (resposta) {
                        for (let i = 0; i < resposta.length; i++) {
                            var publicacao = resposta[i];

                            console.log(publicacao.fkUsuario)
                            const icon = document.getElementById(`icon_curtida${publicacao.fkPublicacao}`);

                            if (idUsuario == publicacao.fkUsuario) {
                                console.log("Já curtiu esse comentario");
                                icon.name = "heart";
                                icon.style.color = "red";
                            } else {
                                console.log("Não curtiu");
                                icon.name = "heart-outline";
                                icon.style.color = "black";
                            }
                        }
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);

            });
        }
    }

    function verificarCheck() {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function (checkbox) {
            checkbox.removeEventListener('click', handleCheckboxClick);
        });
        checkboxes.forEach(function (checkbox) {
            checkbox.addEventListener('click', handleCheckboxClick);
        });
    }

    let fkAutor = '';
    let contadorCurtidas;
    function handleCheckboxClick() {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        if (this.checked) {
            const icon = document.getElementById(`icon_curtida${this.id}`);
            icon.name = "heart";
            icon.style.color = "red";
            var idPublicacaoClicado = this.id;
            console.log(listafkAutor[1].fkAutor)
            for (let posicao = 0; posicao < listafkAutor.length; posicao++) {
                if (idPublicacaoClicado == listafkAutor[posicao].idPublicacao) {
                    fkAutor = listafkAutor[posicao].fkAutor;
                }
            }
            console.log('O checkbox com o ID ' + this.id + ' está selecionado.' + fkAutor);
            curtida.cadastrar(this.id, fkAutor);
        } else {
            const icon = document.getElementById(`icon_curtida${this.id}`);
            icon.name = "heart-outline";
            icon.style.color = "black";
            console.log('O checkbox com o ID ' + this.id + ' não está selecionado.');
            let idPublicacaoClicado = this.id;
            for (let posicao = 0; posicao < listafkAutor.length; posicao++) {
                if (idPublicacaoClicado == listafkAutor[posicao].idPublicacao) {
                    fkAutor = listafkAutor[posicao].fkAutor;
                }
            }
            let idPublicacao = this.id
            fetch(`/interacoes/listar/${usuario.id}/${idPublicacao}/${fkAutor}`, {
            }).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));
                        curtida.deletar(idPublicacao, fkAutor)
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });
        }
    }

    // COMENTÁRIOS =======================================================================
    let fkAutor1;
    let fkAutor2;
    const listafkAutor1 = [];
    const comentario = {
        exibirModal: function () {
            const jsonString = JSON.stringify(listafkAutor);
            const comentarios = document.getElementsByName("comentarios");
            for (var i = 0; i < comentarios.length; i++) {
                if (comentarios[i].checked) {
                    console.log("Valor selecionado:", comentarios[i].value);
                    sessionStorage.ID_POSTAGEM = comentarios[i].value;
                    break;
                }
            }
            sessionStorage.setItem('meuJSON', jsonString);

            const overlay1 = document.getElementById("overlay1");
            overlay1.style.display = "flex";
            localStorage.setItem("divVisivel", "true");

            const divComentario = document.getElementById("div_container_comentarios");
            divComentario.innerHTML = "";
            this.selecionarPublicacao();
            this.listar();
        },
        fecharModal: function () {
            document.getElementById("overlay1").style.display = "none";
            localStorage.removeItem("divVisivel");
        },
        exibirTotal: function () {
            const idPublicacao = sessionStorage.getItem("ID_POSTAGEM");
            fetch(`/interacoes/exibirQtdComentarios/${idPublicacao}`).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));
                        for (let i = 0; i < resposta.length; i++) {
                            const publicacao = resposta[i];
                            if (publicacao.qtdComentario) {
                                var p_comentario = document.getElementById(`p_qtdComentario${publicacao.fkPublicacao}`);
                                p_comentario.innerHTML = publicacao.qtdComentario;
                            }
                        }
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });
        },
        selecionarPublicacao: function () {
            const idPublicacao = sessionStorage.getItem("ID_POSTAGEM");
            fetch(`/interacoes/selecionarPublicacao/${idPublicacao}`).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));
                        const feed = document.getElementById("div_informacoes-pai");
                        for (let i = 0; i < resposta.length; i++) {
                            const publicacao = resposta[i];
                            const divPublicacao = document.getElementById("div_container_pub");
                            divPublicacao.className = "div-container-pub";
                            divPublicacao.innerHTML = `
                            <div class="div-container-post">
                                <div class="div-info-usuario">
                                    <ion-icon name="person-circle" class="usuario"></ion-icon>
                                    <div class="div-nome-pub">
                                        <p class="p-nome">${publicacao.nome}</p>
                                        <p class="p-dataPub">${publicacao.dataPublicacao}</p>
                                    </div>
                                </div>

                                <div class="div-descicao-post">
                                    <p class="p-titulo-publicacao">${publicacao.titulo}</p>
                                    <p class="p-pub-descricao">${publicacao.descricao}</p>
                                </div>
                            </div>       
                            `;
                            feed.appendChild(divPublicacao);
                            listafkAutor1[i] = {
                                idPublicacao: publicacao.idPublicacao,
                                fkAutor: publicacao.fkAutor
                            };
                        }
                        let jsonString1 = JSON.stringify(listafkAutor1);
                        sessionStorage.setItem('meuJSON1', jsonString1);
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });
        },
        listar: function () {
            fetch(`/interacoes/listarComentarios/${usuario.id}/${sessionStorage.getItem("ID_POSTAGEM")}`).then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        throw "Nenhum resultado encontrado!!";
                    }
                    resposta.json().then(function (resposta) {
                        console.log("Dados recebidos: ", JSON.stringify(resposta));
                        var feed = document.getElementById("div_comentarios_pai");
                        for (let i = 0; i < resposta.length; i++) {
                            var publicacao = resposta[i];
                            var divComentario = document.getElementById("div_container_comentarios");
                            divComentario.innerHTML += `
                            <div class="div-container-comentarios-pub">
                                    <div class="div-comentarios-pub coment">
                                        <ion-icon name="person-circle" class="usuario-comentario"></ion-icon>
                                        <div class="div-nome-pub">
                                            <p class="p-nome-comentario">${publicacao.NomeUsuario}</p>
                                            <p class="p-dataPub-comentario">${publicacao.dataComentario}</p>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="mensagem-publicacao">${publicacao.mensagem}</p>    
                                    </div>
                                </div>
                            `;
                            feed.appendChild(divComentario);
                        }
                    });
                } else {
                    throw ('Houve um erro na API!');
                }
            }).catch(function (resposta) {
                console.error(resposta);
            });
        },
        publicar: function () {
            const idPublicacao = sessionStorage.ID_POSTAGEM;
            const mensagem = input_comentarios.value;

            for (let posicao = 0; posicao < listafkAutor1.length; posicao++) {
                if (idPublicacao == listafkAutor1[posicao].idPublicacao) {
                    fkAutor2 = listafkAutor1[posicao].fkAutor;
                }
            }
            fetch(`/publicacoes/publicarComentario/${usuario.id}/${idPublicacao}/${fkAutor2}/${mensagem}`, {
                method: "POST",
            }).then(function (resposta) {
                console.log("resposta: ", resposta);
                if (resposta.ok) {
                    window.alert(`Comentário realizado com sucesso pelo usuario: ${usuario.nome}`);
                    window.location = "/dashboard/inicio.html";
                } else if (resposta.status == 404) {
                    window.alert("Deu 404!");
                } else {
                    throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);

            });
            return false;
        },
        verificarVisibilidade: function () {
            const divVisivel = localStorage.getItem("divVisivel") === "true";
            if (divVisivel) {
                document.getElementById("overlay1").style.display = "flex";
            }
        }
    }

    // ARRUMAR SISTEMA DE PESQUISA !!!!!!!!!!!!!!!!!!!!!

    function pesquisarPublicacao(resposta){
        const publicacaoPesquisada = document.getElementById("input_pesquisar").value;
       
    }

    // function pesquisarPublicacao() {
    //     const publicacaoPesquisada = document.getElementById("input_pesquisar").value;
    //     if (publicacaoPesquisada) {
    //         fetch(`/publicacoes/pesquisarPublicacao/${publicacaoPesquisada}`).then(function (resposta) {
    //             if (resposta.ok) {
    //                 if (resposta.status == 204) {
    //                     throw "Nenhum resultado encontrado!!";
    //                 }
    //                 resposta.json().then(function (resposta) {
    //                     console.log("Dados recebidos: ", JSON.stringify(resposta));
    //                     publicacao.exibir(resposta);
    //                 });
    //             } else {
    //                 throw ('Houve um erro na API!');
    //             }
    //         }).catch(function (resposta) {
    //             console.error(resposta);
    //         });
    //     } else {
    //         atualizarFeed();
    //     }
    // }

    // function pesquisarEnter(){
    //     const inputPesquisar = document.getElementById('input_pesquisar');
    //     inputPesquisar.onkeypress = function (event){
    //         if(event.keyCode == 13){
    //             event.preventDefault();
    //             if(inputPesquisar.value != ''){
    //                 pesquisarPublicacao()
    //             }
    //         }
    //     }
    // }
</script>