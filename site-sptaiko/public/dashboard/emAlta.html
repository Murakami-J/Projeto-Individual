<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sptaiko</title>
    <link rel="stylesheet" href="../css/inicio.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="../js/sessao.js"></script>
    <script src="../js/dinamico.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="validarSessao()">

    <nav>
        <div class="div-logo">
            <img src="../assets/images/logoAnimada.gif" alt="Logo SPTaiko" class="img-logo">
        </div>

        <div class="nav-container">
            <ul>
                <li><a href="inicio.html">INÍCIO</a></li>
                <span class="divisor"></span>
                <li onclick="exibirGrupos()" class="li-seta">GRUPOS <img src="../assets/images/seta-para-baixo.png"
                        alt="" class="seta-baixo"></li>
                <span class="divisor"></span>
                <ul class="ul-grupos" id="ul_grupos">
                    <li><a href="grupo.html" id="gp_acal">Acal Taiko</a></li>
                    <li><a href="grupo.html" id="gp_futurong">Futurong Taiko</a></li>
                    <li><a href="grupo.html" id="gp_himawari">Himawari Taiko</a></li>
                    <li><a href="grupo.html" id="gp_ikkon">Ikkon Wadaiko</a></li>
                    <li><a href="grupo.html" id="gp_mika">Mika Taiko</a></li>
                    <li><a href="grupo.html" id="gp_mugen">Mugen Daiko</a></li>
                    <li><a href="grupo.html" id="gp_sakura">Sakura Fubuki Taiko</a></li>
                    <li><a href="grupo.html" id="gp_soragoi">Soragoi Wadaiko</a></li>
                    <li><a href="grupo.html" id="gp_tenryuu">Tenryuu Wadaiko</a></li>
                    <li><a href="grupo.html" id="gp_todoroki">Todoroki Daiko</a></li>
                </ul>
                <li><a href="emAlta.html">EM ALTA</a></li>
                <span class="divisor"></span>
            </ul>
        </div>


        <div class="container-sair">
            <a href="../index.html">
                <img src="../assets/images/sair.png" alt="Sair">
                <p>SAIR</p>
            </a>
        </div>
    </nav>

    <div class="header-container">
        <div class="div-header">
            <span id="b_usuario">Usuário</span>
            <div class="div-perfil-usuario">
            </div>
        </div>
    </div>

    <div class="div-container-titulo-grafico">
        <span class="material-symbols-outlined">
            local_fire_department
        </span>
        <p>Grupos mais mencionados durante a semana</p>
    </div>
    <div class="div-pai-dashboard">
        <div class="div-container-dashboard">
            <div class="div-grafico" id="div_grafico">
                <canvas id="myChartCanvas"></canvas>
            </div>

            <div class="div-ranking">
                <div class="div-ranking-container">
                    <div class="div-ranking-titulo">
                        <span class="material-symbols-outlined fire">
                            local_fire_department
                        </span>
                        <p class="p-titulo-ranking">TOP 5 publicações mais curtidas durante a semana</p>
                    </div>
                    <div class="div-ranking-usuarios" id="div_ranking_usuarios">

                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="div-pai-kpi">
        <div class="div-container-kpi">
            <div class="div-box-kpi">
                <div class="div-kpi">
                    <p class="kpi-titulo">Total de publicações da semana</p>
                    <div class="div-kpi-info">
                        <ion-icon name="reader-outline" class="icon-publicacao"></ion-icon>
                        <p class="p-kpi" id="p_kpi_1">0</p>
                    </div>
                </div>
                <div class="div-kpi">
                    <p class="kpi-titulo">Maior número de comentários em posts da semana</p>
                    <div class="div-kpi-info">
                        <ion-icon name="chatbubble-ellipses-outline" class="icon-publicacao"></ion-icon>
                        <p class="p-kpi" id="p_kpi_2">0</p>
                    </div>
                </div>
                <div class="div-kpi">
                    <p class="kpi-titulo">Grupo mais mencionado durante a semana</p>
                    <div class="div-kpi-info">
                        <ion-icon name="flame-outline" class="icon-publicacao"></ion-icon>
                        <!-- <ion-icon name="notifications-outline" class="icon-publicacao"></ion-icon> -->
                        <p class="p-kpi p-kpi-gp" id="p_kpi_3">Nenhum</p>
                    </div>
                </div>
                <div class="div-kpi">
                    <p class="kpi-titulo">Usuário com mais posts durante a semana</p>
                    <div class="div-kpi-info kpi-4">
                        <div class="div-kpi-usuario">
                            <ion-icon name="person-circle-outline" class="icon-publicacao"></ion-icon>
                            <p class="p-kpi p-kpi-gp" id="p_kpi_4">Nenhum</p>
                        </div>
                        <div class="div-kpi-qtdPub">
                            <ion-icon name="reader-outline" class="icon-qtdPub"></ion-icon>
                            <p id="p_kpi_4_1">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/ionicons@5.4.0/dist/ionicons.js"></script>
</body>

<script>


    b_usuario.innerHTML = sessionStorage.NOME_USUARIO + sessionStorage.ID_USUARIO;
    let contador = 0;
    function exibirGrupos() {

        if (contador % 2 == 0) {

            gp_acal.style.display = 'flex';
            gp_futurong.style.display = 'flex';
            gp_himawari.style.display = 'flex';
            gp_ikkon.style.display = 'flex';
            gp_mika.style.display = 'flex';
            gp_mugen.style.display = 'flex';
            gp_sakura.style.display = 'flex';
            gp_soragoi.style.display = 'flex';
            gp_tenryuu.style.display = 'flex';
            gp_todoroki.style.display = 'flex';


        } else {
            gp_acal.style.display = 'none';
            gp_futurong.style.display = 'none';
            gp_himawari.style.display = 'none';
            gp_ikkon.style.display = 'none';
            gp_mika.style.display = 'none';
            gp_mugen.style.display = 'none';
            gp_sakura.style.display = 'none';
            gp_soragoi.style.display = 'none';
            gp_tenryuu.style.display = 'none';
            gp_todoroki.style.display = 'none';

        }
        contador += 1;
    }

    let proximaAtualizacao;
    window.onload = obterDadosGrafico();
    window.onload = obterRanking();
    window.onload = exibirTotalPublicacoesSemana();
    window.onload = exibirComentariosPostSemana();
    window.onload = exibirGrupoMaisMencionado();
    window.onload = exibirUsuarioMaisPublicacao();

    function obterDadosGrafico() {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/dashboard/obterDados/`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }



    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Menções',
                color: 'white',
                data: [],
                fill: false,
                borderColor: 'white',
                backgroundColor: [
                    '#B80000',
                ],
                tension: 0.1
            }],
        };

        let opcoes = {
            title: {
                display: true,
                text: 'Custom Chart Title'
            },
            chartArea: {
                backgroundColor: 'rgba(251, 85, 85, 0.4)'
            },
            responsive: true,
            maintainAspectRatio: false, // Isso permite definir o tamanho manualmente
            aspectRatio: 1,
            scales: {
                x: {
                    ticks: {
                        color: '#fff'
                    }
                },
                y: {
                    ticks: {
                        color: '#fff'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            }
        };


        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.nomeGrupo);
            dados.datasets[0].data.push(registro.qtdTotalMencao);
            // dados.datasets[1].data.push(registro.nomeGrupo);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
            options: opcoes
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas`),
            config
        );
        atualizarGrafico(dados, myChart);
        // setTimeout(() => atualizarGrafico(dados, myChart), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(dados, myChart) {



        fetch(`/dashboard/tempo-real`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    obterdados();
                    // alertar(novoRegistro, idAquario);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);




                    if (novoRegistro[0].qtdTotalMencao == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].qtdTotalMencao)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico

                        for (let posicao = 0; posicao < novoRegistro.length; posicao++) {
                            // dados.labels.shift(); // apagar o primeiro
                            // dados.labels.push(novoRegistro[posicao].nomeGrupo); // incluir um novo momento

                            // dados.datasets[posicao].data.shift();  // apagar o primeiro de umidade
                            // dados.datasets[0].data.push(novoRegistro[posicao].qtdTotalMencao); // incluir uma nova medida de umidade

                            // dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                            // dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                            myChart.update();

                        }
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    // proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                // proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }


    const numRank = ['counter_1', 'counter_2', 'counter_3', 'counter_4', 'counter_5']
    function obterRanking() {

        fetch("/dashboard/obterRanking").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    var ranking = document.getElementById("div_ranking_usuarios");
                    ranking.innerHTML = "";
                    let contador = 0;

                    for (let i = 0; i < resposta.length; i++) {
                        console.log("AQUI: " + JSON.stringify(resposta));
                        var topUsuarios = resposta[i];


                        ranking.innerHTML += `
                            <div class="div-topUsuarios">
                                <div class="container-topUsuarios">
                                    <span class="material-symbols-outlined numRank" id='span_numRank${contador}'>
                                    
                                    </span> 
                                    <div class="div-informacao-ranking">
                                        <p class="p-titulo-ranking-autor" id="a">${topUsuarios.titulo}</p>
                                        <p class="p-autor">Por: ${topUsuarios.nome}</p>
                                    </div>
                                </div>
                                <div class="div-ranking-curtida">
                                    <ion-icon name="heart" class="icon-curtida"></ion-icon>
                                    <p>${topUsuarios.qtdCurtida}</p>
                                </div>
                           
                            </div>
                        `;

                        if (contador == 0) {
                            span_numRank0.innerHTML = `${numRank[0]}`
                        } else if (contador == 1) {
                            span_numRank1.innerHTML = `${numRank[1]}`
                        } else if (contador == 2) {
                            span_numRank2.innerHTML = `${numRank[2]}`
                        } else if (contador == 3) {
                            span_numRank3.innerHTML = `${numRank[3]}`
                        } else if (contador == 4) {
                            span_numRank4.innerHTML = `${numRank[4]}`
                        }

                        contador += 1;
                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);

        });

    }

    function exibirTotalPublicacoesSemana() {
        
        fetch(`/dashboard/exibirTotalPublicacoesSemana`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {

                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {
                        var publicacao = resposta[i];

                        if (publicacao.totalPubSem) {
                            var totalPub = document.getElementById(`p_kpi_1`);
                            totalPub.innerHTML = publicacao.totalPubSem;

                        }

                

                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });


    }

    function exibirComentariosPostSemana() {
        
        fetch(`/dashboard/exibirComentariosPostSemana`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {

                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {
                        var publicacao = resposta[i];

                        if (publicacao.maiorNumComentario) {
                            var totalPub = document.getElementById(`p_kpi_2`);
                            totalPub.innerHTML = publicacao.maiorNumComentario;

                        }

                

                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });


    }

    function exibirGrupoMaisMencionado() {
        
        fetch(`/dashboard/exibirGrupoMaisMencionado`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {

                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {
                        var publicacao = resposta[i];

                        if (publicacao.nomeGrupo) {
                            var totalPub = document.getElementById(`p_kpi_3`);
                            totalPub.innerHTML = publicacao.nomeGrupo;

                        }

                

                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });


    }

    function exibirUsuarioMaisPublicacao() {
        
        fetch(`/dashboard/exibirUsuarioMaisPublicacao`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {

                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    for (let i = 0; i < resposta.length; i++) {
                        var publicacao = resposta[i];

                        if (publicacao.nome) {
                            var totalPubUser = document.getElementById(`p_kpi_4`);
                            totalPubUser.innerHTML = publicacao.nome;

                            var totalPub = document.getElementById(`p_kpi_4_1`);
                            totalPub.innerHTML = publicacao.qtdPublicacao;

                        }

                

                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });


    }



</script>